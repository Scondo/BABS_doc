# Сообщение

Сообщения - основная сущность, которой обмениваются авторы.
Это могут быть текстовые сообщения (предназначенные для показа в интерфейсе) или служебные сообщения (предназначенные для передачи дополнительной информации).
При этом текстовые сообщения могут использовать дополнительную разметку, основанную на BBCode, для ссылок на не-текстовые элементы (включая упоминания авторов или медиа-файлы).

## Формат сообщения

| Номер п/п | Длина в байтах | Содержимое |
|---|---|---|
| 1 | 1 | Заголовочный байт |
| 2 | 1 | Параметры сжатия и шифрования |
| 3 | 1 | Дополнительный идентификатор |
| 4 | var (1+) | Время отправления (Unixtime - varint) |
| 5 | var (1+) | Идентификатор автора (публичный ключ подписи или обрезанный публичный ключ подписи) |
| 6 | var (0+) | Если тип не 00 - байтовое представление идентификатора оригинала |
| 7 | var (1+) | N - длина сообщения - Varint |
| 8 | N | Сообщение. |

### Заголовочный байт

| Бит | Значение |
| --- | --- |
| 1 | Тип сообщения: 0 - текстовое сообщение; 1 - служебное сообщение |
| 2-3 | 00 - отдельное сообщение <br/> 01 - ответ <br/> 10 - замена (при замене ответа на кого отвечаем узнаем из оригинального сообщения) <br/> 11 - исправление|
| 4-6 | Резерв. Всегда 0 |
| 7 | Стандарт времени. Пока допустим только 0  - Unix Time |
| 8 | Резерв. Всегда 0 |

### Параметры сжатия и шифрования

Старшие биты описывают параметры сжатия:
- 0001 - zlib
- 0010 - brotli
- Остальное - резерв

Младшие биты описывают параметры шифрования:
- 0001 - шифрование на публичный ключ шифрования получателя
- 0010 - шифрование ранее встречавшимся в чате эфемерным ключом
- Остальное - резерв
