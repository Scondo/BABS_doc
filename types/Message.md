# Сообщение

Сообщения - основная сущность, которой обмениваются авторы.
Это могут быть текстовые сообщения (предназначенные для показа в интерфейсе) или служебные сообщения (предназначенные для передачи дополнительной информации).
При этом текстовые сообщения могут использовать дополнительную разметку, основанную на BBCode, для ссылок на не-текстовые элементы (включая упоминания авторов или медиа-файлы).

## Формат сообщения

| Номер п/п | Длина в байтах | Содержимое |
|---|---|---|
| 1 | 1 | Заголовочный байт |
| 2 | 1 | Параметры сжатия и шифрования |
| 3 | 1 | Дополнительный идентификатор |
| 4 | var (1+) | Время отправления (Unixtime - varint) |
| 5 | var (1+) | Идентификатор автора (публичный ключ подписи или обрезанный публичный ключ подписи) |
| 6 | var (0+) | Если тип не 00 - байтовое представление идентификатора оригинала |
| 7 | var (1+) | N - длина сообщения - Varint |
| 8 | N | Сообщение. |

### Заголовочный байт

| Бит | Значение |
| --- | --- |
| 1 | Тип сообщения: 0 - текстовое сообщение; 1 - служебное сообщение |
| 2-3 | 00 - отдельное сообщение <br/> 01 - ответ <br/> 10 - замена (при замене ответа на кого отвечаем узнаем из оригинального сообщения) <br/> 11 - исправление|
| 4-6 | Резерв. Всегда 0 |
| 7 | Стандарт времени. Пока допустим только 0  - Unix Time |
| 8 | Резерв. Всегда 0 |

#### Тип сообщения

Сообщения бывают текстовые и служебные.

Текстовые сообщения - это текст с BB-like разметкой, представляющий из себя содержательную часть общения. Если клиент встречает текстовое сообщение, с обработкой которого возникает проблема, он всё равно должен по возможности попытаться показать его в интерфейсе пользоваетеля насколько возможно (как минимум факт наличия сообщения).

Служебные сообщения - это deterministicaly encoded CBOR, описывающий дополнительные данные для общения. Обработка служебных сообщений может быть необходима для дальнейшей обработки текстовых сообщений, однако они не являются содержательной частью общения. При невозможности обработать служебное сообщение клиент может попробовать продолжить обработку остальных сообщений, не производя никаких индикаций в пользовательском интерфейсе.

#### Место в цепочке

Сообщения могут быть самостоятельными, ответами на другие сообщения или исправлениями отправленного ранее сообщения.

Отдельное сообщение - это просто сообщение. Обычное новое сообщение в чате.

Ответ - это ответ на одно или несколько сообщений. Содержит прямую ссылку на те сообщения с которыми оно связано. Клиенту может потребоваться скачать упомянутые в ссылке сообщения для полноценной интерпретации ответа.

Замена - когда в ходе общения выясняется, что в сообщении были существенные ошибки и его требуется заменить, используется этот вариант. В этом случае оригинальное сообщение может быть не обязательно скачивать для корректной обработки, но это рекомендуется на случай, если оно само было ответом или заменой. Тем не менее содержимое заменяемого сообщения значения не имеет.

Исправление - когда в ходе общения выясняется, что в сообщении были несущественные ошибки и его требуется исправить, используется этот вариант. В этом случае оригинальное сообщение скачивается и к нему применются изменения в соответствии с разметкой исправлений. Не рекомендуется для служебных сообщений.

#### Формат времени

В настоящее время сообщения описывают время своей отправки при помощи UnixTime времени. В будущем это может быть изменено.

### Параметры сжатия и шифрования

Старшие биты описывают параметры сжатия:
- 0001 - zlib
- 0010 - brotli
- Остальное - резерв

Младшие биты описывают параметры шифрования:
- 0001 - шифрование на публичный ключ шифрования получателя
- 0010 - шифрование ранее встречавшимся в чате эфемерным ключом
- Остальное - резерв
